#!/bin/bash

# Jamf Pro server URL
jamfProURL=""

# Jamf API credentials - Consider using environment variables for these
jamfusername=""
jamfpassword=""

# Function to update the name of a policy in Jamf Pro
update_policy_name() {
    local policy_id="$1"
    local new_policy_name="$2"

    # Update the policy name using the Jamf Pro API with PUT
    if curl -X PUT -H "Content-Type: application/xml" -u "$jamfusername:$jamfpassword" \
        -d "<?xml version='1.0' encoding='utf-8'?><policy><name>$new_policy_name</name></policy>" \
        "$jamfProURL/JSSResource/policies/id/$policy_id" >/dev/null 2>&1; then
        echo "Updated policy name (ID: $policy_id) to: $new_policy_name"
    else
        echo "Failed to update policy name (ID: $policy_id) to: $new_policy_name"
    fi
}

# Get the list of all policies from Jamf Pro
policies_xml=$(curl -s -u "$jamfusername:$jamfpassword" "$jamfProURL/JSSResource/policies")

# Extract policy information and update the name based on the site abbreviations
while read -r policy_id policy_name; do
    # Check if the policy name already contains a valid abbreviation
    if [[ "$policy_name" =~ ^[A-Z]+\ - ]]; then
        echo "Policy name (ID: $policy_id) already has a valid abbreviation: $policy_name"
    else
        # Determine the abbreviation based on the site name (customize as needed)
        case "$policy_name" in
            *"Academic Support") abbreviation="AS";;
            *"Athletics") abbreviation="ATH";;
            *"Cellular Devices") abbreviation="CD";;
            *"College of Arts & Sciences") abbreviation="CAS";;
            *"College of Engineering") abbreviation="ENG";;
            *"Galveston") abbreviation="TAMUG";;
            *"Health") abbreviation="TAMUH";;
            *"IT Research") abbreviation="ITR";;
            *"IT Strategic Alliances & Partnerships") abbreviation="ITSAP";;
            *"Labs & Conference Rooms") abbreviation="LCR";;
            *"Residence Life") abbreviation="RL";;
            *"School of Performance, Visualization & Fine Arts") abbreviation="PVFA";;
            *"School of Veterinary Medicine") abbreviation="SVM";;
            *"Technology Services") abbreviation="TS";;
            *) abbreviation="Global";; # Default to "Global" if not found in the mapping
        esac

        # Update the policy name in Jamf Pro with the abbreviation
        new_policy_name="$abbreviation - $policy_name"
        update_policy_name "$policy_id" "$new_policy_name"
    fi
done < <(echo "$policies_xml" | xmlstarlet sel -t -m "//policy" -v "id" -o $'\t' -v "name" -n)

echo "Updated policy names in Jamf Pro"
